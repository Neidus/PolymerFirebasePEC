<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-media-query/iron-media-query.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../bower_components/iron-image/iron-image.html">

<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../bower_components/paper-item/paper-item.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">

<link rel="import" href="../bower_components/app-layout/app-drawer-layout/app-drawer-layout.html">
<link rel="import" href="../bower_components/app-layout/app-drawer/app-drawer.html">
<link rel="import" href="../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../bower_components/app-layout/app-layout.html">
<link rel="import" href="../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">


<link rel="import" href="../bower_components/neon-animation/web-animations.html">
<link rel="import" href="../bower_components/polymerfire/polymerfire.html">

<link rel="import" href="shrine-list.html">
<link rel="import" href="shrine-detail.html">
<link rel="import" href="lista-ranking.html">

<dom-module id="shrine-app">

  <template>

    <style>

      :host {
        -webkit-tap-highlight-color: rgba(0, 0, 0, 0);
      }

      app-header {
        background-color: rgba(255, 255, 255, 0.95);
        --app-header-shadow: {
          box-shadow: inset 0px 5px 6px -3px rgba(0, 0, 0, 0.2);
          height: 10px;
          bottom: -10px;
        };
      }

      app-header:not([shadow]) {
        border-bottom: 1px solid #ddd;
      }

      app-drawer {
        --app-drawer-content-container: {
          background-color: #f3f3f3;
        };
      }

      #mainToolbar {
        height: 110px;
      }

      paper-icon-button {
        color: #000;
        --paper-icon-button-ink-color: #31f0ef;
      }

      

      paper-listbox {
        height: 90px;
        width: 90px;
        font-size: 14px;
        position: relative; z-index: 4000;
      }
       

      .navItem {
        @apply --layout-self-start;
        margin-top: 13px;
      }

      .navItem2 {
        @apply --layout-self-start;
        margin-top: 1px;
      }

      .spacer {
        @apply --layout;
        @apply --layout-flex-auto;
        @apply --layout-center-center;
      }

      .logo {
        width: 240px;
        height: 80px;
        background-size: 100% 100%;
      }

      .leftItem [icon] {
        display: none;
      }


      shrine-detail {
        height: calc(100vh - 65px);
      }

      :host([page=detail]) #mainToolbar {
        height: 64px;
      }

      :host([page=detail]) paper-tabs {
        display: none;
      }

      :host([page=detail]) .leftItem [icon=arrow-back] {
        display: block;
      }

      :host([page=detail]) .leftItem [icon=menu] {
        display: none;
      }

      paper-tabs {
        --paper-tabs-selection-bar-color: #31f0ef;
        margin-left: -55px;
        color: #31f0ef;
        font-size: 13px;
      }

      paper-tab {
        @apply --layout-flex-none;
        padding: 0;
        --paper-tab-ink: #31f0ef;
      }

      paper-tab a {
        @apply --layout-horizontal;
        @apply --layout-center-center;
        text-decoration: none;
        text-transform: uppercase;
        color: #7c7c7c;
        font-weight: 500;
        padding: 0 20px;
        height: 100%;
      }

      .list {
        margin-left: 20px;
        margin-right: 20px;
      }

      .list a {
        display: block;
        line-height: 40px;
        text-decoration: none;
        text-transform: uppercase;
        color: #7c7c7c;
      }

      .list a.active {
        color: black;
        font-weight: bold;
      }

      .profileBar {
        margin-bottom: 40px;
      }

      .profilePic {
        border-radius: 50% 50%;
      }

      .profileName {
        @apply --layout-flex;
        margin-left: 20px;
        font-size: 14px;
        font-weight: 500;
        color: #0a3142;
      }

      [icon=settings] {
        width: 35px;
        height: 35px;
        color: #0a3142;
      }

      /**
       * Desktop small, tablet
       */
      @media (max-width: 1200px) {
        .logo {
          width: 140px;
          height: 50px;
        }

        #mainToolbar {
          height: 64px;
        }

        shrine-detail {
          height: auto;
        }
      }

      /**
       * Phone
       */
      @media (max-width: 500px) {
        .leftItem [icon=menu] {
          display: block;
        }

        paper-tabs {
          display: none;
        }
      }

    </style>


    <!-- Conexion a la BBDD -->
    <firebase-app
    auth-domain="primerproyecto-166008.firebaseapp.com"
    database-url="https://primerproyecto-166008.firebaseio.com/"
    api-key="AIzaSyDjCmVSTejjAzRZaXtLgKS1ti9fHi4JTE0">
    </firebase-app>
    <firebase-auth 
      id="auth"
      user="{{user}}"
      provider="google"
      on-error="handleError">
    </firebase-auth>

    <app-location route="{{route}}" use-hash-as-path></app-location>
    <app-route
        route="{{route}}"
        pattern=":section"
        data="{{sectionData}}"
        tail="{{subRoute}}"></app-route>
    <app-route
        route="{{subRoute}}"
        pattern="/:id"
        data="{{idData}}"
        active="{{onDetailPage}}"></app-route>

    <iron-media-query query="max-width: 500px" query-matches="{{smallScreen}}"></iron-media-query>

    <iron-pages selected="[[_usuarioLogeado]]" attr-for-selected="name" fallback-selection="login">


      <div name="login">
        <h1>Usuario no identificado!</h1>
        <paper-button raised on-tap="_hacerLogin">Login</paper-button>
      </div>

      
      <app-drawer-layout drawer-width="288px" force-narrow name="logeado">
        <!-- menú de navegación para la izquierda cuando la web es pequeña-->
        <app-drawer slot="drawer" id="drawer" swipe-open="[[smallScreen]]">
          <template is="dom-if" if="[[smallScreen]]">
            <app-toolbar class="profileBar">
              <img class="profilePic" src="[[user.photoURL]]"  width="30" height="30">
              <div class="profileName">[[user.displayName]]</div>
                 
              <paper-menu-button>
                  <paper-icon-button icon="settings" aria-label="Settings" slot="dropdown-trigger" alt="menu"></paper-icon-button>
                  <paper-listbox slot="dropdown-content">
                    <paper-button onclick = "window.location='#cuenta'">Cuenta</paper-button>
                    <paper-button on-tap="_cerrarSesion">Cerrar Sesión</paper-button>
                  </paper-listbox>
              </paper-menu-button>
            </app-toolbar>
            <div class="list">
              <template is="dom-repeat" items="[[sections]]" as="section" initial-count="1">
                <a href="#[[section]]" class$="[[_getSectionClass(index, selectedTab)]]">[[section]]</a>
              </template>
            </div>
          </template>
        </app-drawer>

        <app-header-layout id="headerLayout">
          <!-- menú de cabecera -->
          <app-header slot="header" effects="waterfall" fixed="[[smallScreen]]" condenses="[[!smallScreen]]" reveals="[[!smallScreen]]">

            <app-toolbar id="mainToolbar">
              <div class="navItem leftItem">
                <paper-icon-button icon="menu" drawer-toggle alt="Toogle navigation menu"></paper-icon-button>
                <a href="#[[sectionData.section]]" tabindex="-1"><paper-icon-button icon="arrow-back"  alt="Back to the home"></paper-icon-button></a>
              </div>
              <div class="spacer">
                <img src="../img/logoLF_OT.jpg" class="logo" alt="SHRINE">
              </div>
              <template is="dom-if" if="[[_shouldShowTabs(onDetailPage, smallScreen)]]">
                  <app-toolbar class="navItem2 profileBar rightItem" if="[[_shouldShowTabs(onDetailPage, smallScreen)]]">
                      <img class="profilePic" src="[[user.photoURL]]"  width="30" height="30">
                      <div class="profileName">[[user.displayName]]</div>
                      <paper-menu-button>
                          <paper-icon-button icon="settings" aria-label="Settings" slot="dropdown-trigger" alt="menu"></paper-icon-button>
                          <paper-listbox slot="dropdown-content">
                            <paper-button onclick = "window.location='#cuenta'">Cuenta</paper-button>
                            <paper-button on-tap="_cerrarSesion">Cerrar Sesión</paper-button>
                          </paper-listbox>
                      </paper-menu-button>
                  </app-toolbar>
              </template>
            </app-toolbar>

            <template is="dom-if" if="[[_shouldShowTabs(onDetailPage, smallScreen)]]">
              <paper-tabs selected="[[selectedTab]]" scrollable sticky$="[[_shouldShowTabs(onDetailPage, smallScreen)]]">
                <template is="dom-repeat" items="[[sections]]" as="section">
                  <paper-tab>
                    <a href="#[[section]]">[[section]]</a>
                  </paper-tab>
                </template>
              </paper-tabs>
            </template>

          </app-header>


          <!-- zona inferior de la página web -->
          <iron-pages selected="[[sectionData.section]]" attr-for-selected="name" >
            <iron-pages selected="[[page]]" attr-for-selected="name" name="hola">
              <!-- detail of item -->
              <template is="dom-if" if="[[_equal(page, 'detail')]]">
                <shrine-detail
                    name="detail"
                    section="[[sectionData.section]]"
                    related-items="[[items]]"
                    item="[[_getDetailItem(items, idData.id)]]">
                </shrine-detail>
              </template>
              <!-- list of items -->
              <template is="dom-if" if="[[_equal(page, 'list')]]">
                <shrine-list
                    name="list"
                    section="[[sectionData.section]]"
                    items="[[_getItemsCopy(items, sectionData.section)]]"
                    featured-item="[[_getFeaturedItem(featuredItems, sectionData.section)]]">
                </shrine-list>
              </template>
            </iron-pages>
            <iron-pages  selected="[[page]]" attr-for-selected="name" name="programas">
              
              <!-- list of items -->
              <template is="dom-if" if="[[_equal(page, 'list')]]">
                <shrine-list name="list" section="[[sectionData.section]]" items="[[_getItemsCopy(items, sectionData.section)]]" featured-item="[[_getFeaturedItem(featuredItems, sectionData.section)]]">
                </shrine-list>
              </template>

            </iron-pages>

            <iron-pages  selected="[[page]]" attr-for-selected="name" name="elegir concursantes">
              Mostramos los concursantes y los creditos que cuestas y elegimos con cuales nos quedamos para que nos contabilicen las puntuaciones.
              Luego ya implementariamos el limite de creditos.
            </iron-pages>

            <iron-pages  selected="[[page]]" attr-for-selected="name" name="rankings">
              <template is="dom-if" if="[[_equal(page, 'list')]]">
                <lista-ranking  name="list">
                </lista-ranking>
              </template>
              
            </iron-pages>

            <iron-pages  selected="[[page]]" attr-for-selected="name" name="cuenta">
              Aqui info de la cuenta seleccionada. Habra que revisar la forma de llegar a aqui si podemos entrar en los perfiles de las cuentas de cualquiera.
            </iron-pages>
          </iron-pages>
          

        </app-header-layout>
      </app-drawer-layout>
    </iron-pages>

  </template>

  <script>

  Polymer({

    is: 'shrine-app',

    properties: {

      sections: {
        type: Array,
        value: function() {
          return [
            'programas',
            'elegir concursantes',
            'rankings',
            'furniture',
            'beauty',
            'food',
            'travel'
          ];
        }
      },

      selectedTab: {
        type: Number,
        computed: '_computeSelectedTab(sections, sectionData.section)'
      },

      items: {
        type: Array
      },

      featuredItems: {
        type: Array
      },

      page: {
        type: String,
        computed: '_computePage(onDetailPage)',
        reflectToAttribute: true
      },

      route: Object,

      subRoute: Object,

      sectionData: Object,

      idData: Object,

      onDetailPage: Boolean,

      user: Object,

      _usuarioLogeado: {
        type: String,
        computed: '_calcularLogin(user)'
      }


    },

    observers: [
      '_hashDidChange(route.path, items, featuredItems)'
    ],

    attached: function() {
      this.async(function() {
        if (!this.route.path) {
          this.set('route.path', 'feature');
        }
      });
    },

    _computeSelectedTab: function(sections, section) {
      return sections.indexOf(section);
    },

    _getItemsCopy: function(items) {
      return items ? items.slice() : [];
    },

    /*Devuelve el featured item segun la categoria elegida
    teniendo que coincidir con la guardada en el json de los datos
    Nosotros lo que haremos sera coger el documento del programa destacado
    de la bbdd para ponerlo en dicho componente destacado. Simpre será
    el ultimo programa introducido en la bbdd.
    Ahora si cambiamos las categorias no nos carga a no ser que cambiemos la
    categoria tambien en el json. Hay que andarse con ojo.
    */
    _getFeaturedItem: function(featuredItems, section) {
      if (featuredItems && section) {
        return featuredItems.filter(function(item) {
          return item.category.toLowerCase() === section;
        }).pop();
      }
      return '';
    },

    _getDetailItem: function(items, id) {
      if (items) {
        return items[id];
      }
    },

    _computePage: function(onDetailPage) {
      return onDetailPage ? 'detail' : 'list';
    },

    _hashDidChange: function() {
      Polymer.AppLayout.scroll({ top: 0, behavior: 'silent' });
      this.$.headerLayout.resetLayout();
      this.$.drawer.close();
    },

    _equal: function(a, b) {
      return a === b;
    },

    _getSectionClass: function(index, selectedTab) {
      return index === selectedTab ? 'active' : '';
    },

    _shouldShowTabs: function(onDetailPage, smallScreen) {
      return !onDetailPage && !smallScreen;
    },

    _hacerLogin: function() {
      return this.$.auth.signInWithPopup(this.$.auth.provider);
    },

    _calcularLogin:function(usuario) {
      return ((this.$.auth.user === undefined || this.$.auth.user === null)?"login":"logeado");
    },

    _cerrarSesion:function() {
      console.log(this.$.auth.user);
      this.$.auth.signOut();
    }

  });

  </script>

</dom-module>
